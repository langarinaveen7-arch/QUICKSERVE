<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captain Dashboard - QuickServe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100">

    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Captain Dashboard</h1>
            <button id="logout-btn" class="bg-red-500 text-white py-2 px-4 rounded-full hover:bg-red-600">Logout</button>
        </nav>
    </header>

    <main class="container mx-auto px-6 py-8">
        <h2 class="text-3xl font-bold mb-6">Available Service Requests</h2>
        <div id="jobs-container" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Jobs will be loaded here by JavaScript -->
            <p id="loading-text">Loading available jobs...</p>
        </div>
    </main>

    <script>
        const backendApiUrl = 'http://localhost:3002';
        const token = localStorage.getItem('quickServeToken');

        // --- Authentication Check ---
        if (!token) {
            window.location.href = './auth-v2.html'; // Redirect if not logged in
        }

        // --- UI Elements ---
        const jobsContainer = document.getElementById('jobs-container');
        const loadingText = document.getElementById('loading-text');
        const logoutBtn = document.getElementById('logout-btn');

        // --- Functions ---
        async function fetchJobs() {
            try {
                const response = await fetch(`${backendApiUrl}/api/jobs`, {
                    headers: { 'x-auth-token': token }
                });

                if (response.status === 403) {
                     jobsContainer.innerHTML = `<p class="text-red-500 font-semibold">Access Denied. This page is for Captains only.</p>`;
                     return;
                }
                if (!response.ok) throw new Error('Failed to fetch jobs.');
                
                const jobs = await response.json();
                displayJobs(jobs);

            } catch (error) {
                loadingText.textContent = `Error: ${error.message}`;
                loadingText.classList.add('text-red-500');
            }
        }

        function displayJobs(jobs) {
            jobsContainer.innerHTML = ''; // Clear loading text
            if (jobs.length === 0) {
                jobsContainer.innerHTML = '<p>No available jobs at the moment. Check back soon!</p>';
                return;
            }

            jobs.forEach(job => {
                const jobCard = document.createElement('div');
                jobCard.className = 'bg-white p-6 rounded-lg shadow-lg';
                jobCard.innerHTML = `
                    <h3 class="font-bold text-xl mb-2">${job.service}</h3>
                    <p class="text-gray-600 mb-4"><strong>Location:</strong> ${job.location}</p>
                    <p class="text-gray-600 mb-4"><strong>Customer:</strong> ${job.customer}</p>
                    <button data-job-id="${job.id}" class="accept-btn w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition duration-300 font-semibold">Accept Job</button>
                `;
                jobsContainer.appendChild(jobCard);
            });
        }

        async function acceptJob(jobId) {
            try {
                const response = await fetch(`${backendApiUrl}/api/jobs/accept/${jobId}`, {
                    method: 'POST',
                    headers: { 'x-auth-token': token }
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);

                alert('Job accepted successfully!');
                fetchJobs(); // Refresh the list of jobs
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        function logout() {
            localStorage.removeItem('quickServeToken');
            window.location.href = './index.html';
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', fetchJobs);
        logoutBtn.addEventListener('click', logout);
        jobsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('accept-btn')) {
                const jobId = e.target.dataset.jobId;
                acceptJob(jobId);
            }
        });
    </script>
</body>
</html>
